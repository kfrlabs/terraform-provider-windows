name: Release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
      GPG_HOME: /tmp/gpg-home
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Set provider name and version
        run: |
          REPO_NAME=${GITHUB_REPOSITORY##*/}
          VERSION=${GITHUB_REF_NAME#v}
          echo "REPO_NAME=$REPO_NAME" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Repository: $REPO_NAME, Version: $VERSION"

      - name: Build binaries
        run: |
          mkdir -p dist
          for os in linux darwin windows freebsd; do
            for arch in 386 amd64 arm arm64; do
              # Skip unsupported combinations
              if [[ "$os" == "darwin" && ("$arch" == "386" || "$arch" == "arm") ]]; then
                continue
              fi
              
              echo "Building for $os/$arch"
              
              # Set the correct binary extension for Windows
              BINARY_EXT=""
              if [[ "$os" == "windows" ]]; then
                BINARY_EXT=".exe"
              fi
              
              # Build the binary with the exact name Terraform expects
              # REPO_NAME already contains "terraform-provider-windows"
              BINARY_NAME="${REPO_NAME}_v${VERSION}${BINARY_EXT}"
              GOOS=$os GOARCH=$arch go build -o "${BINARY_NAME}"
              
              # Create zip archive with the binary at the root (not in dist/)
              # Extract provider name from repo name for zip filename
              PROVIDER_NAME=${REPO_NAME#terraform-provider-}
              zip "dist/${PROVIDER_NAME}_${VERSION}_${os}_${arch}.zip" "${BINARY_NAME}"
              rm "${BINARY_NAME}"
            done
          done

      - name: Generate checksums
        run: |
          cd dist
          PROVIDER_NAME=${REPO_NAME#terraform-provider-}
          sha256sum *.zip > ${PROVIDER_NAME}_${VERSION}_SHA256SUMS

      - name: Setup GPG directory
        run: |
          mkdir -p "$GPG_HOME"
          chmod 700 "$GPG_HOME"

      - name: Import GPG key
        run: |
          export GNUPGHOME="$GPG_HOME"
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          gpg --list-secret-keys

      - name: Sign artifacts
        run: |
          export GNUPGHOME="$GPG_HOME"
          cd dist
          PROVIDER_NAME=${REPO_NAME#terraform-provider-}
          # Sign zip files (binary signature, not ASCII armored)
          for file in *.zip; do
            gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --detach-sign "$file"
          done
          # Sign SHASUMS file (binary signature, not ASCII armored)
          gpg --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --detach-sign "${PROVIDER_NAME}_${VERSION}_SHA256SUMS"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}